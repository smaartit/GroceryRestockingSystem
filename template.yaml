AWSTemplateFormatVersion: "2010-09-09"
Transform: "AWS::Serverless-2016-10-31"
Description: "Grocery Restocking System"

Resources:
  GroceryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: GroceryList
      AttributeDefinitions:
        - AttributeName: Id
          AttributeType: S
        - AttributeName: Name
          AttributeType: S
      KeySchema:
        - AttributeName: Id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: NameIndex
          KeySchema:
            - AttributeName: Name
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

  PantryItemsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: PantryItems
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Id
          AttributeType: S
      KeySchema:
        - AttributeName: Id
          KeyType: HASH
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES # Enabling DynamoDB Stream to detect quantity changes

  # Dead-letter queue for failed stream events
  PantryItemsStreamDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: PantryItemsStreamDLQ
      MessageRetentionPeriod: 1209600 # 14 days

  # Direct stream handler for PantryItems - replaces outbox pattern
  PantryItemsStreamHandler:
    Type: "AWS::Serverless::Function"
    Properties:
      Handler: PantryItemsStreamHandler::PantryItemsStreamHandler.PantryItemsStreamHandler::FunctionHandler
      Runtime: dotnet8
      CodeUri: ./src/PantryItemsStreamHandler
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          GROCERY_TABLE: !Ref GroceryTable
          DLQ_URL: !GetAtt PantryItemsStreamDLQ.QueueUrl
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt PantryItemsTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
            MaximumRetryAttempts: 3
            BisectBatchOnFunctionError: true
            DestinationConfig:
              OnFailure:
                Type: SQS
                Destination: !GetAtt PantryItemsStreamDLQ.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GroceryTable
        - DynamoDBReadPolicy:
            TableName: !Ref PantryItemsTable
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt PantryItemsStreamDLQ.Arn

  GroceryRestockingApi:
    Type: "AWS::Serverless::Api"
    Properties:
      Name: "GroceryRestockingApi"
      StageName: "prod"
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"
      DefinitionBody:
        swagger: "2.0"
        info:
          title: "Grocery Restocking API"
          version: "1.0"
        paths:
          /consume-item:
            options:
              summary: "CORS preflight for consume-item"
              operationId: "consumeItemOptions"
              responses:
                "200":
                  description: "CORS preflight response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  "200":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
                    responseTemplates:
                      application/json: ""
            post:
              summary: "Trigger an event for consumed item restocking"
              operationId: "consumeItem"
              parameters:
                - in: body
                  name: item
                  description: "Item information"
                  required: true
                  schema:
                    type: object
                    properties:
                      itemId:
                        type: string
                      itemName:
                        type: string
              responses:
                "200":
                  description: "Item consumption event triggered"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${ApiConsumeItemFunction.Arn}/invocations"
                passthroughBehavior: "when_no_match"
          /items:
            options:
              summary: "CORS preflight for items"
              operationId: "itemsOptions"
              responses:
                "200":
                  description: "CORS preflight response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  "200":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
                    responseTemplates:
                      application/json: ""
            get:
              summary: "Get all items from the pantry"
              operationId: "getPantryItems"
              responses:
                "200":
                  description: "List of pantry items"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
                  schema:
                    type: array
                    items:
                      type: object
                "500":
                  description: "Internal server error"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${GetPantryItemsFunction.Arn}/invocations"
                passthroughBehavior: "when_no_match"
            post:
              summary: "Add a new item to the pantry"
              operationId: "addItem"
              parameters:
                - in: body
                  name: item
                  description: "Item information"
                  required: true
                  schema:
                    type: object
                    properties:
                      name:
                        type: string
                      category:
                        type: string
                      quantity:
                        type: integer
                      price:
                        type: number
              responses:
                "200":
                  description: "Item added successfully"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${AddItemFunction.Arn}/invocations"
                passthroughBehavior: "when_no_match"
          /grocery-list:
            options:
              summary: "CORS preflight for grocery-list"
              operationId: "groceryListOptions"
              responses:
                "200":
                  description: "CORS preflight response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  "200":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
                    responseTemplates:
                      application/json: ""
            get:
              summary: "Get all items from the grocery list"
              operationId: "getGroceryList"
              responses:
                "200":
                  description: "List of grocery list items"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
                  schema:
                    type: array
                    items:
                      type: object
                "500":
                  description: "Internal server error"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${GetGroceryListFunction.Arn}/invocations"
                passthroughBehavior: "when_no_match"
          /grocery-list/{id}:
            options:
              summary: "CORS preflight for grocery-list/{id}"
              operationId: "groceryListItemOptions"
              parameters:
                - in: path
                  name: id
                  required: true
                  type: string
              responses:
                "200":
                  description: "CORS preflight response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  "200":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
                    responseTemplates:
                      application/json: ""
            delete:
              summary: "Delete an item from the grocery list"
              operationId: "deleteGroceryListItem"
              parameters:
                - in: path
                  name: id
                  required: true
                  type: string
              responses:
                "200":
                  description: "Item deleted successfully"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
                "400":
                  description: "Bad request"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
                "500":
                  description: "Internal server error"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${DeleteGroceryListItemFunction.Arn}/invocations"
                passthroughBehavior: "when_no_match"
          /items/{id}:
            options:
              summary: "CORS preflight for update item"
              operationId: "updateItemOptions"
              parameters:
                - in: path
                  name: id
                  required: true
                  type: string
              responses:
                "200":
                  description: "CORS preflight response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  "200":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
                    responseTemplates:
                      application/json: ""
            put:
              summary: "Update item stock"
              operationId: "updateItem"
              parameters:
                - in: path
                  name: id
                  required: true
                  type: string
                - in: body
                  name: stockUpdate
                  description: "Stock update information"
                  required: true
                  schema:
                    type: object
                    properties:
                      quantity:
                        type: integer
              responses:
                "200":
                  description: "Item updated successfully"
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Headers:
                      type: string
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${UpdateStockFunction.Arn}/invocations"
                passthroughBehavior: "when_no_match"

  # API Gateway Lambda Permissions
  ApiConsumeItemFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ApiConsumeItemFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GroceryRestockingApi}/*/*"

  AddItemFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AddItemFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GroceryRestockingApi}/*/*"

  UpdateStockFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref UpdateStockFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GroceryRestockingApi}/*/*"

  GetPantryItemsFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetPantryItemsFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GroceryRestockingApi}/*/*"

  GetGroceryListFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetGroceryListFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GroceryRestockingApi}/*/*"

  DeleteGroceryListItemFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DeleteGroceryListItemFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GroceryRestockingApi}/*/*"

  # API Gateway Lambda integration
  ApiConsumeItemFunction:
    Type: "AWS::Serverless::Function"
    Properties:
      Handler: ApiConsumeItem::ApiConsumeItem.ApiConsumeItem::FunctionHandler
      Runtime: dotnet8
      CodeUri: ./src/ApiConsumeItem
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          PANTRY_ITEMS_TABLE: !Ref PantryItemsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PantryItemsTable

  AddItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/AddItemFunction
      Handler: AddItemFunction::AddItemFunction.AddItemFunction::FunctionHandler
      Runtime: dotnet8
      Architectures:
        - x86_64
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          PANTRY_ITEMS_TABLE: !Ref PantryItemsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PantryItemsTable

  GetPantryItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/GetPantryItemsFunction
      Handler: GetPantryItemsFunction::GetPantryItemsFunction.GetPantryItemsFunction::FunctionHandler
      Runtime: dotnet8
      Architectures:
        - x86_64
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          PANTRY_ITEMS_TABLE: !Ref PantryItemsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref PantryItemsTable

  GetGroceryListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/GetGroceryListFunction
      Handler: GetGroceryListFunction::GetGroceryListFunction.GetGroceryListFunction::FunctionHandler
      Runtime: dotnet8
      Architectures:
        - x86_64
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          GROCERY_TABLE: !Ref GroceryTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref GroceryTable

  DeleteGroceryListItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/DeleteGroceryListItemFunction
      Handler: DeleteGroceryListItemFunction::DeleteGroceryListItemFunction.DeleteGroceryListItemFunction::FunctionHandler
      Runtime: dotnet8
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 10
      Environment:
        Variables:
          GROCERY_TABLE: !Ref GroceryTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GroceryTable

  UpdateStockFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: UpdateStockFunction::UpdateStockFunction.UpdateStockFunction::FunctionHandler
      Runtime: dotnet8
      CodeUri: ./src/UpdateStockFunction
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          GROCERY_TABLE: !Ref GroceryTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GroceryTable

Outputs:
  GroceryRestockingApiUrl:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${GroceryRestockingApi}.execute-api.us-east-1.amazonaws.com/prod/consume-item"
  ItemsEndpointUrl:
    Description: "API Gateway endpoint URL for items endpoint"
    Value: !Sub "https://${GroceryRestockingApi}.execute-api.us-east-1.amazonaws.com/prod/items"
  UpdateItemEndpointUrl:
    Description: "API Gateway endpoint URL for update item endpoint"
    Value: !Sub "https://${GroceryRestockingApi}.execute-api.us-east-1.amazonaws.com/prod/items/{id}"
